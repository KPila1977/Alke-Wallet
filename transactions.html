<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Historial - Alke Wallet</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="../css/styles.css">
    <style>
        .filter-active {
            background-color: var(--secondary-color) !important;
            color: white !important;
        }
        .historical-badge {
            background-color: #6c757d !important;
        }
        .new-badge {
            background-color: #198754 !important;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-alke navbar-expand-lg sticky-top">
        <div class="container">
            <a class="navbar-brand text-white" href="../index.html">
                <i class="bi bi-wallet2"></i> Alke Wallet
            </a>
            <div class="navbar-nav ms-auto">
                <a href="menu.html" class="nav-item nav-link text-white">
                    <i class="bi bi-arrow-left"></i> Volver al Menú
                </a>
            </div>
        </div>
    </nav>

    <div class="container py-5">
        <h1 class="mb-4">
            <i class="bi bi-clock-history"></i> Historial de Transacciones
        </h1>
        
        <!-- Información de moneda -->
        <div class="alert alert-info mb-4">
            <i class="bi bi-currency-exchange"></i>
            <strong>Moneda:</strong> Pesos Chilenos (CLP) | 
            <strong>Transacciones históricas</strong> (gris) no se modifican
        </div>
        
        <!-- Filtros -->
        <div class="card shadow mb-4 fade-in">
            <div class="card-body">
                <h5 class="mb-3">
                    <i class="bi bi-funnel"></i> Filtros
                </h5>
                <div class="d-flex flex-wrap gap-2">
                    <button class="btn btn-outline-primary filter-btn active" data-filter="all">
                        Todas
                    </button>
                    <button class="btn btn-outline-success filter-btn" data-filter="income">
                        <i class="bi bi-arrow-down-circle"></i> Ingresos
                    </button>
                    <button class="btn btn-outline-danger filter-btn" data-filter="expense">
                        <i class="bi bi-arrow-up-circle"></i> Egresos
                    </button>
                    <button class="btn btn-outline-info filter-btn" data-filter="new">
                        <i class="bi bi-star"></i> Nuevas
                    </button>
                    <button class="btn btn-outline-secondary filter-btn" data-filter="historical">
                        <i class="bi bi-archive"></i> Históricas
                    </button>
                    <button class="btn btn-outline-warning filter-btn" data-filter="today">
                        Hoy
                    </button>
                </div>
                
                <!-- Búsqueda -->
                <div class="mt-3">
                    <div class="input-group">
                        <span class="input-group-text">
                            <i class="bi bi-search"></i>
                        </span>
                        <input type="text" class="form-control" id="searchTransaction" 
                               placeholder="Buscar por descripción o contacto...">
                    </div>
                </div>
            </div>
        </div>

        <!-- Estadísticas -->
        <div class="row mb-4 fade-in">
            <div class="col-md-3">
                <div class="card bg-primary text-white">
                    <div class="card-body">
                        <h6>Total Ingresos</h6>
                        <h4 id="totalIncome">$ 0</h4>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-danger text-white">
                    <div class="card-body">
                        <h6>Total Egresos</h6>
                        <h4 id="totalExpense">$ 0</h4>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-success text-white">
                    <div class="card-body">
                        <h6>Balance Neto</h6>
                        <h4 id="netBalance">$ 0</h4>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-info text-white">
                    <div class="card-body">
                        <h6>Transacciones</h6>
                        <h4 id="totalTransactions">0</h4>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabla de transacciones -->
        <div class="card shadow fade-in">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Tipo</th>
                                <th>Descripción</th>
                                <th>Contacto</th>
                                <th class="text-end">Monto (CLP)</th>
                                <th class="text-center">Estado</th>
                            </tr>
                        </thead>
                        <tbody id="transactionsTable">
                            <!-- Transacciones se cargarán con JavaScript -->
                        </tbody>
                    </table>
                </div>
                
                <!-- Paginación -->
                <nav class="mt-4">
                    <ul class="pagination justify-content-center">
                        <li class="page-item disabled">
                            <a class="page-link" href="#">Anterior</a>
                        </li>
                        <li class="page-item active"><a class="page-link" href="#">1</a></li>
                        <li class="page-item"><a class="page-link" href="#">2</a></li>
                        <li class="page-item"><a class="page-link" href="#">3</a></li>
                        <li class="page-item">
                            <a class="page-link" href="#">Siguiente</a>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
        
        <!-- Información adicional -->
        <div class="card shadow mt-4">
            <div class="card-body">
                <h5><i class="bi bi-info-circle"></i> Información</h5>
                <ul class="mb-0">
                    <li>Las transacciones <span class="badge historical-badge">Históricas</span> son datos de ejemplo y no se modifican</li>
                    <li>Las transacciones <span class="badge new-badge">Nuevas</span> son las que tú realizas con fecha actual</li>
                    <li>Todos los montos están en Pesos Chilenos (CLP)</li>
                    <li>El historial se guarda en tu navegador (localStorage)</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../js/main.js"></script>
    <script>
        $(document).ready(function() {
            // Cargar transacciones
            loadAllTransactions();
            updateStats();
            
            // Filtros
            $('.filter-btn').click(function() {
                $('.filter-btn').removeClass('filter-active');
                $(this).addClass('filter-active');
                
                const filter = $(this).data('filter');
                filterTransactions(filter);
            });
            
            // Búsqueda
            $('#searchTransaction').on('input', function() {
                const searchTerm = $(this).val().toLowerCase();
                filterBySearch(searchTerm);
            });
        });
        
        function formatCLP(amount) {
            return new Intl.NumberFormat('es-CL').format(amount);
        }
        
        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const today = now.toISOString().split('T')[0];
            const yesterday = new Date(now.setDate(now.getDate() - 1)).toISOString().split('T')[0];
            
            if (dateString === today) {
                return `<strong>Hoy</strong><br><small>${date.toLocaleTimeString('es-CL', { hour: '2-digit', minute: '2-digit' })}</small>`;
            } else if (dateString === yesterday) {
                return `<strong>Ayer</strong><br><small>${date.toLocaleDateString('es-CL', { month: 'short', day: 'numeric' })}</small>`;
            } else {
                return date.toLocaleDateString('es-CL', {
                    day: '2-digit',
                    month: 'short',
                    year: 'numeric'
                });
            }
        }
        
        function loadAllTransactions() {
            if (typeof getAllTransactions === 'undefined') {
                console.error('getAllTransactions no está definido');
                return;
            }
            
            const transactions = getAllTransactions();
            renderTransactions(transactions);
        }
        
        function renderTransactions(transactions) {
            const table = $('#transactionsTable');
            table.empty();
            
            if (transactions.length === 0) {
                table.html(`
                    <tr>
                        <td colspan="6" class="text-center py-4">
                            <i class="bi bi-inbox" style="font-size: 3rem; opacity: 0.3;"></i>
                            <p class="mt-2 text-muted">No se encontraron transacciones</p>
                            <a href="deposit.html" class="btn btn-primary btn-sm mt-2">
                                <i class="bi bi-plus-circle"></i> Realizar tu primera transacción
                            </a>
                        </td>
                    </tr>
                `);
                return;
            }
            
            // Ordenar por fecha (más reciente primero)
            transactions.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            transactions.forEach(transaction => {
                const row = createTransactionRow(transaction);
                table.append(row);
            });
        }
        
        function createTransactionRow(transaction) {
            const isIncome = transaction.type === 'income';
            const isHistorical = transaction.isHistorical === true;
            const typeText = isIncome ? 'Ingreso' : 'Egreso';
            const typeClass = isIncome ? 'text-success' : 'text-danger';
            const amountClass = isIncome ? 'text-success' : 'text-danger';
            const icon = isIncome ? 'bi-arrow-down-circle' : 'bi-arrow-up-circle';
            const badgeClass = isHistorical ? 'historical-badge' : 'new-badge';
            const badgeText = isHistorical ? 'Histórica' : 'Nueva';
            
            const amountSign = isIncome ? '+' : '-';
            const formattedAmount = `$${formatCLP(transaction.amount)}`;
            
            return `
                <tr class="transaction-item ${transaction.type} ${isHistorical ? 'table-secondary' : ''}">
                    <td>
                        <div style="min-width: 100px;">
                            ${formatDate(transaction.date)}
                        </div>
                    </td>
                    <td>
                        <span class="badge ${isIncome ? 'bg-success' : 'bg-danger'}">
                            <i class="bi ${icon}"></i> ${typeText}
                        </span>
                    </td>
                    <td>${transaction.description}</td>
                    <td>${transaction.contact}</td>
                    <td class="text-end ${amountClass} fw-bold">
                        ${amountSign} ${formattedAmount}
                    </td>
                    <td class="text-center">
                        <span class="badge ${badgeClass}">
                            ${badgeText}
                        </span>
                    </td>
                </tr>
            `;
        }
        
        function filterTransactions(filter) {
            if (typeof getAllTransactions === 'undefined') return;
            
            const allTransactions = getAllTransactions();
            let filtered = [...allTransactions];
            
            switch(filter) {
                case 'income':
                    filtered = filtered.filter(t => t.type === 'income');
                    break;
                case 'expense':
                    filtered = filtered.filter(t => t.type === 'expense');
                    break;
                case 'new':
                    filtered = filtered.filter(t => t.isHistorical === false);
                    break;
                case 'historical':
                    filtered = filtered.filter(t => t.isHistorical === true);
                    break;
                case 'today':
                    const today = new Date().toISOString().split('T')[0];
                    filtered = filtered.filter(t => t.date === today);
                    break;
                // 'all' no filtra
            }
            
            renderTransactions(filtered);
        }
        
        function filterBySearch(searchTerm) {
            if (typeof getAllTransactions === 'undefined') return;
            
            if (!searchTerm) {
                loadAllTransactions();
                return;
            }
            
            const allTransactions = getAllTransactions();
            const filtered = allTransactions.filter(transaction => 
                transaction.description.toLowerCase().includes(searchTerm) ||
                transaction.contact.toLowerCase().includes(searchTerm) ||
                transaction.type.toLowerCase().includes(searchTerm)
            );
            
            renderTransactions(filtered);
        }
        
        function updateStats() {
            if (typeof getAllTransactions === 'undefined') return;
            
            const transactions = getAllTransactions();
            
            const totalIncome = transactions
                .filter(t => t.type === 'income')
                .reduce((sum, t) => sum + t.amount, 0);
            
            const totalExpense = transactions
                .filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + t.amount, 0);
            
            const netBalance = totalIncome - totalExpense;
            
            $('#totalIncome').text('$ ' + formatCLP(totalIncome));
            $('#totalExpense').text('$ ' + formatCLP(totalExpense));
            $('#netBalance').text('$ ' + formatCLP(netBalance));
            $('#totalTransactions').text(transactions.length);
        }
    </script>
</body>
</html>